resources:

- name: compute-engine-full-storage-sa
  type: iam.v1.serviceAccount
  properties:
    accountId: ce-full-storage@{{ env["project"] }}.iam.gserviceaccount.com
- name: get-iam-policy
    action: gcp-types/cloudresourcemanager-v1:cloudresourcemanager.projects.getIamPolicy
    properties:
      resource: {{ env["project"] }}
- name: set-iam-policy
  action: gcp-types/cloudresourcemanager-v1:cloudresourcemanager.projects.setIamPolicy
    properties:
      resource: {{ env["project"] }}
      policy: $(ref.get-iam-policy)
      gcpIamPolicyPatch:
        add:
        - role: roles/compute.admin
          members:
          - serviceAccount:ce-full-storage@{{ env["project"] }}.iam.gserviceaccount.com
        - role: roles/storage.admin
          members:
          - serviceAccount:ce-full-storage@{{ env["project"] }}.iam.gserviceaccount.com

{% for clusterInstance in properties["instances"] %}
- type: compute.v1.instances
  name: {{ clusterInstance["name"] }}
  properties:
    zone: {{ clusterInstance["zone"] }}
    machineType: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/zones/{{ clusterInstance["zone"] }}/machineTypes/{{ clusterInstance["machineType"] }}
    {% if clusterInstance.tags is defined %}
    tags:
      items: ["portainer"]
    {% endif %}
    metadata:
      items:
      - key: startup-script
        value: |
          {{ clusterInstance["startup-script"]|indent(10) }}
    serviceAccounts:
    - email: ce-full-storage@{{ env["project"] }}.iam.gserviceaccount.com
      scopes: ["https://www.googleapis.com/auth/devstorage.read_write"]
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      sizeGB: {{ clusterInstance["diskSizeGB"] }}
      initializeParams:
        sourceImage: https://www.googleapis.com/compute/v1/{{ clusterInstance["os-image"] }}
    networkInterfaces:
    - network: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/global/networks/default
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT
{% endfor %}

- type: compute.v1.firewall
  name: portainer-firewall
  properties: 
    network: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/global/networks/default
    sourceRanges: ["0.0.0.0/0"]
    targetTags: ["portainer"]
    allowed:
    - IPProtocol: tcp
      ports: ["8000", "9000"]
- type: compute.v1.firewall
  name: nextcloud-http
  properties: 
    network: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/global/networks/default
    sourceRanges: ["0.0.0.0/0"]
    targetTags: ["nextcloud"]
    allowed:
    - IPProtocol: tcp
      ports: ["80"]